<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{inventory/layout :: head('엑셀 Import')}"></head>
<body>
    <nav th:replace="~{inventory/layout :: sidebar}"></nav>

    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title">엑셀 Import</h1>
        </div>

        <!-- Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-upload me-2"></i>파일 업로드
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">엑셀 파일 선택</label>
                            <input type="file" class="form-control" id="excelFile"
                                   accept=".xlsx,.xls">
                            <div class="form-text">
                                .xlsx 또는 .xls 파일을 선택해주세요.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">적용 년월</label>
                            <input type="month" class="form-control" id="yearMonth"
                                   th:value="${currentYearMonth}">
                            <div class="form-text">
                                재고 데이터를 적용할 년월
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-center">
                        <button type="button" class="btn btn-primary w-100" onclick="parseFile()">
                            <i class="bi bi-file-earmark-check me-1"></i>파일 분석
                        </button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle me-1"></i>엑셀 파일 형식 안내</h6>
                    <p class="mb-2">첫 번째 행에 다음 헤더가 포함되어야 합니다:</p>
                    <ul class="mb-0">
                        <li><strong>제품명/품명</strong> (필수): 제품 이름</li>
                        <li><strong>카테고리/분류</strong>: 제품 카테고리</li>
                        <li><strong>월초재고/기초재고</strong>: 월초 재고 수량</li>
                        <li><strong>사용량</strong>: 사용한 수량</li>
                        <li><strong>유효기간</strong>: 제품 유효기간 (날짜 형식)</li>
                        <li><strong>단위</strong>: 수량 단위 (개, box 등)</li>
                        <li><strong>비고</strong>: 추가 메모</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card" id="previewSection" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table me-2"></i>미리보기</span>
                <span class="badge bg-primary" id="previewCount">0개</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th style="width: 50px;">행</th>
                                <th style="min-width: 180px;">제품명</th>
                                <th style="width: 100px;">카테고리</th>
                                <th style="width: 80px;">월초재고</th>
                                <th style="width: 80px;">사용량</th>
                                <th style="width: 100px;">유효기간</th>
                                <th style="width: 60px;">단위</th>
                                <th>비고</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="updateExisting">
                            <label class="form-check-label" for="updateExisting">
                                기존 제품 정보 업데이트 (체크 해제 시 기존 제품은 스킵)
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="clearPreview()">
                            취소
                        </button>
                        <button type="button" class="btn btn-success" onclick="importData()">
                            <i class="bi bi-download me-1"></i>Import 실행
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Section -->
        <div class="card mt-4" id="resultSection" style="display: none;">
            <div class="card-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>Import 완료
            </div>
            <div class="card-body">
                <div id="resultMessage"></div>
                <div id="resultErrors" class="mt-3" style="display: none;">
                    <h6 class="text-danger">오류 목록:</h6>
                    <ul id="errorList" class="text-danger"></ul>
                </div>
                <div class="mt-3">
                    <a th:href="@{/inventory/stocks}" class="btn btn-primary">
                        <i class="bi bi-graph-up me-1"></i>재고 현황 보기
                    </a>
                    <a th:href="@{/inventory/products}" class="btn btn-outline-primary">
                        <i class="bi bi-box me-1"></i>제품 관리 보기
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        let parsedData = [];

        function parseFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/inventory/import/parse', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                    return;
                }

                parsedData = result.data;
                renderPreview(parsedData);
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('resultSection').style.display = 'none';
            })
            .catch(error => {
                alert('파일 분석 실패: ' + error.message);
            });
        }

        function renderPreview(data) {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';

            document.getElementById('previewCount').textContent = data.length + '개';

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.rowNumber || '-'}</td>
                    <td>${item.productName || ''}</td>
                    <td><span class="badge bg-info">${item.category || ''}</span></td>
                    <td class="text-end">${item.initialStock || 0}</td>
                    <td class="text-end">${item.usedQuantity || 0}</td>
                    <td>${item.expiryDate || ''}</td>
                    <td>${item.unit || '개'}</td>
                    <td><small class="text-muted">${item.note || ''}</small></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearPreview() {
            parsedData = [];
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('excelFile').value = '';
        }

        function importData() {
            if (parsedData.length === 0) {
                alert('Import할 데이터가 없습니다.');
                return;
            }

            const yearMonth = document.getElementById('yearMonth').value;
            if (!yearMonth) {
                alert('적용 년월을 선택해주세요.');
                return;
            }

            const updateExisting = document.getElementById('updateExisting').checked;

            if (!confirm(`${parsedData.length}개의 데이터를 ${yearMonth}에 Import하시겠습니까?`)) {
                return;
            }

            fetch('/api/inventory/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: parsedData,
                    yearMonth: yearMonth,
                    updateExisting: updateExisting
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('previewSection').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('resultMessage').innerHTML = `
                        <div class="alert alert-success mb-0">
                            <strong>Import 완료!</strong><br>
                            ${result.message}
                        </div>
                    `;

                    if (result.result.errors && result.result.errors.length > 0) {
                        document.getElementById('resultErrors').style.display = 'block';
                        const errorList = document.getElementById('errorList');
                        errorList.innerHTML = '';
                        result.result.errors.forEach(err => {
                            const li = document.createElement('li');
                            li.textContent = err;
                            errorList.appendChild(li);
                        });
                    }

                    clearPreview();
                } else {
                    alert('Import 실패: ' + result.error);
                }
            })
            .catch(error => {
                alert('Import 실패: ' + error.message);
            });
        }
    </script>
</body>
</html>
