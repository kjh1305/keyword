<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{inventory/layout :: head('제품 관리')}"></head>
<body>
    <nav th:replace="~{inventory/layout :: sidebar}"></nav>

    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title">제품 관리</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openCreateModal()">
                <i class="bi bi-plus-lg me-1"></i>제품 등록
            </button>
        </div>

        <!-- Search & Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form class="row g-3" method="get" th:action="@{/inventory/products}">
                    <div class="col-md-3">
                        <label class="form-label">카테고리</label>
                        <select name="category" class="form-select">
                            <option value="">전체</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat}"
                                    th:text="${cat}"
                                    th:selected="${cat == selectedCategory}"></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">제품명 검색</label>
                        <input type="text" name="keyword" class="form-control"
                               placeholder="제품명을 입력하세요" th:value="${keyword}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="bi bi-search me-1"></i>검색
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Product List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>제품 목록</span>
                <span class="badge bg-secondary" th:text="${products.totalElements} + '개'"></span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 60px;">번호</th>
                                <th>제품명</th>
                                <th style="width: 120px;">카테고리</th>
                                <th style="width: 100px;">최소수량</th>
                                <th style="width: 80px;">단위</th>
                                <th>비고</th>
                                <th style="width: 120px;">관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="product, stat : ${products.content}">
                                <td th:text="${products.number * products.size + stat.index + 1}"></td>
                                <td th:text="${product.name}"></td>
                                <td>
                                    <span class="badge bg-info" th:text="${product.category}" th:if="${product.category}"></span>
                                </td>
                                <td class="text-end" th:text="${product.minQuantity}"></td>
                                <td th:text="${product.unit}"></td>
                                <td>
                                    <small class="text-muted" th:text="${product.note}"></small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1"
                                            th:onclick="'openEditModal(' + ${product.id} + ')'">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger"
                                            th:onclick="'deleteProduct(' + ${product.id} + ')'">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${products.empty}">
                                <td colspan="7" class="text-center py-4 text-muted">
                                    등록된 제품이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Pagination -->
            <div class="card-footer" th:if="${products.totalPages > 1}">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item" th:classappend="${products.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/inventory/products(page=${products.number - 1}, category=${selectedCategory}, keyword=${keyword})}">이전</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, products.totalPages - 1)}"
                            th:classappend="${i == products.number} ? 'active'">
                            <a class="page-link" th:href="@{/inventory/products(page=${i}, category=${selectedCategory}, keyword=${keyword})}"
                               th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${products.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/inventory/products(page=${products.number + 1}, category=${selectedCategory}, keyword=${keyword})}">다음</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">제품 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label class="form-label">제품명 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">카테고리</label>
                            <input type="text" class="form-control" id="productCategory"
                                   list="categoryList" placeholder="카테고리를 입력하세요">
                            <datalist id="categoryList">
                                <option th:each="cat : ${categories}" th:value="${cat}"></option>
                            </datalist>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">최소 수량</label>
                                <input type="number" class="form-control" id="productMinQuantity" value="0" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">단위</label>
                                <input type="text" class="form-control" id="productUnit" value="개">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">비고</label>
                            <textarea class="form-control" id="productNote" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        let isEditMode = false;

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = '제품 등록';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productUnit').value = '개';
            document.getElementById('productMinQuantity').value = '0';
        }

        function openEditModal(id) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = '제품 수정';

            fetch('/api/inventory/products/' + id)
                .then(response => response.json())
                .then(product => {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category || '';
                    document.getElementById('productMinQuantity').value = product.minQuantity || 0;
                    document.getElementById('productUnit').value = product.unit || '개';
                    document.getElementById('productNote').value = product.note || '';

                    new bootstrap.Modal(document.getElementById('productModal')).show();
                })
                .catch(error => {
                    alert('제품 정보를 불러오는데 실패했습니다.');
                });
        }

        function saveProduct() {
            const data = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value || null,
                minQuantity: parseInt(document.getElementById('productMinQuantity').value) || 0,
                unit: document.getElementById('productUnit').value || '개',
                note: document.getElementById('productNote').value || null
            };

            if (!data.name) {
                alert('제품명을 입력해주세요.');
                return;
            }

            const url = isEditMode
                ? '/api/inventory/products/' + document.getElementById('productId').value
                : '/api/inventory/products';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                location.reload();
            })
            .catch(error => {
                alert('저장 실패: ' + error.message);
            });
        }

        function deleteProduct(id) {
            if (!confirm('이 제품을 삭제하시겠습니까?')) return;

            fetch('/api/inventory/products/' + id, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) throw new Error('삭제 실패');
                    location.reload();
                })
                .catch(error => {
                    alert('삭제에 실패했습니다.');
                });
        }
    </script>
</body>
</html>
