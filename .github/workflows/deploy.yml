name: Docker Build and Deploy via SSH

on:
  push:
    branches:
      - main # 배포할 브랜치 지정

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
            java-version: '17'
            distribution: 'temurin'

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}

  deploy-via-ssh:
    needs: build-and-push # 이미지 빌드 후 실행
    runs-on: ubuntu-latest
    steps:
      - name: Determine current active container name
        id: get-current
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_SSH_HOST }}
          username: ${{ secrets.REMOTE_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          script: grep -Po 'proxy_pass http://\K[a-zA-Z0-9\-]+(?=:8888;)' /home/dev/nginx/conf.d/default.conf

      - name: Set current container env
        run: echo "CURRENT_CONTAINER=${{ steps.get-current.outputs.stdout }}" >> $GITHUB_ENV

      - name: Set next prot and contatiner
        run: |
          if [ "${{ env.CURRENT_CONTAINER }}" = "demo-app" ]; then
            echo "NEW_CONTAINER=demo-app-green" >> $GITHUB_ENV
            echo "OLD_CONTAINER=demo-app" >> $GITHUB_ENV
            echo "NEW_PORT=8889" >> $GITHUB_ENV
            echo "OLD_PORT=8888" >> $GITHUB_ENV
          else
            echo "NEW_CONTAINER=demo-app" >> $GITHUB_ENV
            echo "OLD_CONTAINER=demo-app-green" >> $GITHUB_ENV
            echo "NEW_PORT=8888" >> $GITHUB_ENV
            echo "OLD_PORT=8889" >> $GITHUB_ENV
          fi

      - name: SSH into server and deploy new container
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          NEW_CONTAINER: ${{ env.NEW_CONTAINER }}
          NEW_PORT: ${{ env.NEW_PORT }}
        with:
          host: ${{ secrets.REMOTE_SSH_HOST }}
          username: ${{ secrets.REMOTE_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          envs: GHCR_TOKEN,GITHUB_ACTOR,GITHUB_REPOSITORY,GITHUB_SHA,NEW_CONTAINER,NEW_PORT
          script: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
            docker pull ghcr.io/$GITHUB_REPOSITORY:$GITHUB_SHA
            docker rm -f $NEW_CONTAINER 2>/dev/null || true
            docker run -d \
              --name $NEW_CONTAINER \
              --network app-network \
              -p $NEW_PORT:8888 \
              -e TZ=Asia/Seoul \
              -e JAVA_TOOL_OPTIONS="-Duser.timezone=Asia/Seoul" \
              -v /home/dev/config/application-prod.properties:/app/config/application-prod.properties \
              ghcr.io/$GITHUB_REPOSITORY:$GITHUB_SHA

      - name: new container check
        uses: appleboy/ssh-action@v1.0.3
        env:
          NEW_CONTAINER: ${{ env.NEW_CONTAINER }}
          NEW_PORT: ${{ env.NEW_PORT }}
        with:
          host: ${{ secrets.REMOTE_SSH_HOST }}
          username: ${{ secrets.REMOTE_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          envs: NEW_CONTAINER,NEW_PORT
          script: |
            for i in {1..30}; do
              sleep 5
              STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$NEW_PORT/health || echo "000")
              echo "Health check attempt $i: $STATUS"
              if [ "$STATUS" = "200" ]; then
                echo "Health check passed, waiting for app to fully initialize..."
                sleep 10
                # 추가 확인: 연속 3회 성공해야 전환
                SUCCESS=0
                for j in {1..3}; do
                  CHECK=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$NEW_PORT/health || echo "000")
                  if [ "$CHECK" = "200" ]; then
                    SUCCESS=$((SUCCESS + 1))
                    echo "Readiness check $j: OK"
                  else
                    echo "Readiness check $j: FAILED"
                    break
                  fi
                  sleep 2
                done
                if [ "$SUCCESS" = "3" ]; then
                  echo "App is fully ready"
                  exit 0
                fi
              fi
            done
            echo "Health check failed - showing container logs:"
            docker logs $NEW_CONTAINER
            docker rm -f $NEW_CONTAINER
            exit 1

      - name: Update Nginx configuration
        uses: appleboy/ssh-action@v1.0.3
        env:
          NEW_CONTAINER: ${{ env.NEW_CONTAINER }}
          NEW_PORT: ${{ env.NEW_PORT }}
        with:
          host: ${{ secrets.REMOTE_SSH_HOST }}
          username: ${{ secrets.REMOTE_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          envs: NEW_CONTAINER,NEW_PORT
          script: |
            # 전환 전 새 컨테이너 최종 확인
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$NEW_PORT/health || echo "000")
            if [ "$STATUS" != "200" ]; then
              echo "New container not ready, aborting switch"
              exit 1
            fi

            # Nginx 설정 변경
            sed -i "s|proxy_pass http://[a-zA-Z0-9\-]\+:8888;|proxy_pass http://$NEW_CONTAINER:8888;|" /home/dev/nginx/conf.d/default.conf

            # Nginx 설정 검증 후 reload
            docker exec nginx-server nginx -t && docker exec nginx-server nginx -s reload

            echo "Nginx switched to $NEW_CONTAINER"
            sleep 5

            # 전환 후 실제 서비스 확인
            for i in {1..5}; do
              LIVE_STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost/health || echo "000")
              echo "Live check $i: $LIVE_STATUS"
              if [ "$LIVE_STATUS" = "200" ]; then
                echo "Traffic switch successful"
                exit 0
              fi
              sleep 2
            done
            echo "Warning: Live check failed but continuing..."

      - name: Remove old container
        uses: appleboy/ssh-action@v1.0.3
        env:
          OLD_CONTAINER: ${{ env.OLD_CONTAINER }}
        with:
          host: ${{ secrets.REMOTE_SSH_HOST }}
          username: ${{ secrets.REMOTE_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          envs: OLD_CONTAINER
          script: |
            echo "Waiting for existing connections to drain..."
            sleep 10
            docker rm -f $OLD_CONTAINER || true
            echo "Old container removed"
